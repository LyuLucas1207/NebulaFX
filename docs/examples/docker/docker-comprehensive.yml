# NebulaFX Comprehensive Docker Deployment Examples
# This file demonstrates various deployment scenarios for NebulaFX with console separation

version: "3.8"

services:
  # Basic deployment with default settings
  nebulafx-basic:
    image: nebulafx/nebulafx:latest
    container_name: nebulafx-basic
    ports:
      - "9000:9000"  # API endpoint
      - "9001:9001"  # Console interface
    environment:
      - NEUBULAFX_ADDRESS=0.0.0.0:9000
      - NEUBULAFX_CONSOLE_ADDRESS=0.0.0.0:9001
      - NEUBULAFX_EXTERNAL_ADDRESS=:9000
      - NEUBULAFX_CORS_ALLOWED_ORIGINS=http://localhost:9001
      - NEUBULAFX_CONSOLE_CORS_ALLOWED_ORIGINS=*
      - NEUBULAFX_ACCESS_KEY=admin
      - NEUBULAFX_SECRET_KEY=password
    volumes:
      - nebulafx-basic-data:/data
    networks:
      - nebulafx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -f http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - basic

  # Development environment with debug logging
  nebulafx-dev:
    image: nebulafx/nebulafx:latest
    container_name: nebulafx-dev
    ports:
      - "9010:9000"  # API endpoint  
      - "9011:9001"  # Console interface
    environment:
      - NEUBULAFX_ADDRESS=0.0.0.0:9000
      - NEUBULAFX_CONSOLE_ADDRESS=0.0.0.0:9001
      - NEUBULAFX_EXTERNAL_ADDRESS=:9010
      - NEUBULAFX_CORS_ALLOWED_ORIGINS=*
      - NEUBULAFX_CONSOLE_CORS_ALLOWED_ORIGINS=*
      - NEUBULAFX_ACCESS_KEY=dev-admin
      - NEUBULAFX_SECRET_KEY=dev-password
      - RUST_LOG=debug
      - NEUBULAFX_LOG_LEVEL=debug
    volumes:
      - nebulafx-dev-data:/data
      - nebulafx-dev-logs:/logs
    networks:
      - nebulafx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -f http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - dev

  # Production environment with security hardening
  nebulafx-production:
    image: nebulafx/nebulafx:latest
    container_name: nebulafx-production
    ports:
      - "9020:9000"    # API endpoint (public)
      - "127.0.0.1:9021:9001"  # Console (localhost only)
    environment:
      - NEUBULAFX_ADDRESS=0.0.0.0:9000
      - NEUBULAFX_CONSOLE_ADDRESS=0.0.0.0:9001
      - NEUBULAFX_EXTERNAL_ADDRESS=:9020
      - NEUBULAFX_CORS_ALLOWED_ORIGINS=https://myapp.com,https://api.myapp.com
      - NEUBULAFX_CONSOLE_CORS_ALLOWED_ORIGINS=https://admin.myapp.com
      - NEUBULAFX_CONSOLE_RATE_LIMIT_ENABLE=true
      - NEUBULAFX_CONSOLE_RATE_LIMIT_RPM=60
      - NEUBULAFX_CONSOLE_AUTH_TIMEOUT=1800
      - NEUBULAFX_ACCESS_KEY_FILE=/run/secrets/nebulafx_access_key
      - NEUBULAFX_SECRET_KEY_FILE=/run/secrets/nebulafx_secret_key
    volumes:
      - nebulafx-production-data:/data
      - nebulafx-production-logs:/logs
      - nebulafx-certs:/certs:ro
    networks:
      - nebulafx-network
    secrets:
      - nebulafx_access_key
      - nebulafx_secret_key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -f http://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - production

  # Enterprise deployment with TLS and full security
  nebulafx-enterprise:
    image: nebulafx/nebulafx:latest
    container_name: nebulafx-enterprise
    ports:
      - "9030:9000"    # API endpoint
      - "127.0.0.1:9443:9001"  # Console with TLS (localhost only)
    environment:
      - NEUBULAFX_ADDRESS=0.0.0.0:9000
      - NEUBULAFX_CONSOLE_ADDRESS=0.0.0.0:9001
      - NEUBULAFX_EXTERNAL_ADDRESS=:9030
      - NEUBULAFX_TLS_PATH=/certs
      - NEUBULAFX_CORS_ALLOWED_ORIGINS=https://enterprise.com
      - NEUBULAFX_CONSOLE_CORS_ALLOWED_ORIGINS=https://admin.enterprise.com
      - NEUBULAFX_CONSOLE_RATE_LIMIT_ENABLE=true
      - NEUBULAFX_CONSOLE_RATE_LIMIT_RPM=30
      - NEUBULAFX_CONSOLE_AUTH_TIMEOUT=900
    volumes:
      - nebulafx-enterprise-data:/data
      - nebulafx-enterprise-logs:/logs
      - nebulafx-enterprise-certs:/certs:ro
    networks:
      - nebulafx-secure-network
    secrets:
      - nebulafx_enterprise_access_key
      - nebulafx_enterprise_secret_key
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -f http://localhost:9000/health && curl -k -f https://localhost:9001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - enterprise

  # API-only deployment (console disabled)
  nebulafx-api-only:
    image: nebulafx/nebulafx:latest
    container_name: nebulafx-api-only
    ports:
      - "9040:9000"    # API endpoint only
    environment:
      - NEUBULAFX_ADDRESS=0.0.0.0:9000
      - NEUBULAFX_CONSOLE_ENABLE=false
      - NEUBULAFX_CORS_ALLOWED_ORIGINS=https://client-app.com
      - NEUBULAFX_ACCESS_KEY=api-only-key
      - NEUBULAFX_SECRET_KEY=api-only-secret
    volumes:
      - nebulafx-api-data:/data
    networks:
      - nebulafx-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - api-only

  # Nginx reverse proxy for production
  nginx-proxy:
    image: nginx:alpine
    container_name: nebulafx-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - nebulafx-network
    restart: unless-stopped
    depends_on:
      - nebulafx-production
    profiles:
      - production
      - enterprise

networks:
  nebulafx-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  nebulafx-secure-network:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  nebulafx-basic-data:
    driver: local
  nebulafx-dev-data:
    driver: local
  nebulafx-dev-logs:
    driver: local
  nebulafx-production-data:
    driver: local
  nebulafx-production-logs:
    driver: local
  nebulafx-enterprise-data:
    driver: local
  nebulafx-enterprise-logs:
    driver: local
  nebulafx-enterprise-certs:
    driver: local
  nebulafx-api-data:
    driver: local
  nebulafx-certs:
    driver: local

secrets:
  nebulafx_access_key:
    external: true
  nebulafx_secret_key:
    external: true
  nebulafx_enterprise_access_key:
    external: true
  nebulafx_enterprise_secret_key:
    external: true